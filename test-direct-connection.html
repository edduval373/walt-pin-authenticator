<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Connection Test - No Vite</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        button { padding: 10px 20px; margin: 10px 0; cursor: pointer; }
        pre { background-color: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Pin Authentication - Direct Connection Test</h1>
    <p>Testing direct connection to master server without Vite interference</p>
    
    <div class="test-section">
        <h2>Test 1: Direct Master Server Connection</h2>
        <button onclick="testDirectMasterConnection()">Test Direct Connection</button>
        <div id="direct-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Backend Proxy Connection</h2>
        <button onclick="testBackendProxy()">Test Backend Proxy</button>
        <div id="proxy-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: CORS Investigation</h2>
        <button onclick="testCORSDetails()">Investigate CORS</button>
        <div id="cors-result"></div>
    </div>

    <script>
        // Test sample image (1x1 transparent PNG)
        const testImage = "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==";
        
        // Generate session ID
        function generateSessionId() {
            const now = new Date();
            return `${String(now.getFullYear()).slice(-2)}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
        }

        async function testDirectMasterConnection() {
            const resultDiv = document.getElementById('direct-result');
            resultDiv.innerHTML = '<p>Testing direct connection to master server...</p>';
            
            try {
                const sessionId = generateSessionId();
                const requestData = {
                    sessionId: sessionId,
                    frontImageData: testImage
                };

                console.log('Direct connection attempt:', {
                    url: 'https://master.pinauth.com/mobile-upload',
                    method: 'POST',
                    body: requestData
                });

                const response = await fetch('https://master.pinauth.com/mobile-upload', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': 'pim_mobile_2505271605_7f8d9e2a1b4c6d8f9e0a1b2c3d4e5f6g'
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'test-section success';
                    resultDiv.innerHTML = `
                        <h3>✅ SUCCESS - Direct Connection Works!</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Success:</strong> ${data.success}</p>
                        <p><strong>Authenticity Rating:</strong> ${data.authenticityRating}%</p>
                        <p><strong>Session ID:</strong> ${data.sessionId}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Direct connection failed:', error);
                resultDiv.className = 'test-section error';
                resultDiv.innerHTML = `
                    <h3>❌ FAILED - Direct Connection Blocked</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Likely Cause:</strong> CORS (Cross-Origin Resource Sharing) restriction</p>
                    <p><strong>Browser Security:</strong> Blocking cross-origin request to external domain</p>
                    <pre>${error.stack || error.toString()}</pre>
                `;
            }
        }

        async function testBackendProxy() {
            const resultDiv = document.getElementById('proxy-result');
            resultDiv.innerHTML = '<p>Testing backend proxy connection...</p>';
            
            try {
                const requestData = {
                    frontImage: `data:image/png;base64,${testImage}`
                };

                console.log('Backend proxy attempt:', {
                    url: '/api/analyze',
                    method: 'POST',
                    body: requestData
                });

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const data = await response.json();
                    resultDiv.className = 'test-section success';
                    resultDiv.innerHTML = `
                        <h3>✅ SUCCESS - Backend Proxy Works!</h3>
                        <p><strong>Status:</strong> ${response.status}</p>
                        <p><strong>Success:</strong> ${data.success}</p>
                        <p><strong>Authenticity Rating:</strong> ${data.authenticityRating}%</p>
                        <p><strong>Session ID:</strong> ${data.sessionId}</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Backend proxy failed:', error);
                resultDiv.className = 'test-section error';
                resultDiv.innerHTML = `
                    <h3>❌ FAILED - Backend Proxy Issue</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <pre>${error.stack || error.toString()}</pre>
                `;
            }
        }

        async function testCORSDetails() {
            const resultDiv = document.getElementById('cors-result');
            resultDiv.innerHTML = '<p>Investigating CORS configuration...</p>';
            
            try {
                // Test CORS preflight
                const response = await fetch('https://master.pinauth.com/mobile-upload', {
                    method: 'OPTIONS'
                });

                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
                };

                resultDiv.className = 'test-section';
                resultDiv.innerHTML = `
                    <h3>CORS Configuration Analysis</h3>
                    <p><strong>Current Origin:</strong> ${window.location.origin}</p>
                    <p><strong>Target Domain:</strong> https://master.pinauth.com</p>
                    <p><strong>OPTIONS Response Status:</strong> ${response.status}</p>
                    <h4>CORS Headers:</h4>
                    <pre>${JSON.stringify(corsHeaders, null, 2)}</pre>
                    <h4>Conclusion:</h4>
                    <p>${corsHeaders['Access-Control-Allow-Origin'] ? 
                        'CORS is configured, but may not allow this origin' : 
                        'No CORS headers detected - cross-origin requests will be blocked'}</p>
                `;
            } catch (error) {
                resultDiv.className = 'test-section error';
                resultDiv.innerHTML = `
                    <h3>CORS Investigation Results</h3>
                    <p><strong>Error:</strong> ${error.message}</p>
                    <p><strong>Conclusion:</strong> Master server does not support CORS for web browsers</p>
                    <p><strong>Solution:</strong> Backend proxy is required for web applications</p>
                `;
            }
        }

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            console.log('Running connection tests without Vite interference...');
        });
    </script>
</body>
</html>